<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study PDF Viewer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #525659;
      color: #e8eaed;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      text-align: center;
      padding: 40px;
    }

    h1 {
      font-size: 36px;
      margin-bottom: 20px;
      font-weight: 300;
    }

    p {
      font-size: 16px;
      color: #9aa0a6;
      margin-bottom: 40px;
    }

    .button-group {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: center;
    }

    button {
      background-color: #8ab4f8;
      color: #202124;
      border: none;
      padding: 12px 32px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      min-width: 200px;
    }

    button:hover {
      background-color: #aac9ff;
    }

    button:active {
      background-color: #6fa0f7;
    }

    .secondary-button {
      background-color: transparent;
      color: #8ab4f8;
      border: 1px solid #5f6368;
    }

    .secondary-button:hover {
      background-color: #5f6368;
      color: #e8eaed;
    }

    .drop-zone {
      border: 2px dashed #5f6368;
      border-radius: 8px;
      padding: 60px;
      margin-top: 40px;
      transition: all 0.3s;
    }

    .drop-zone.drag-over {
      border-color: #8ab4f8;
      background-color: rgba(138, 180, 248, 0.1);
    }

    .drop-zone p {
      margin: 0;
      font-size: 14px;
    }

    .recent-files {
      margin-top: 60px;
      text-align: left;
      max-width: 600px;
    }

    .recent-files h2 {
      font-size: 18px;
      margin-bottom: 16px;
      font-weight: 400;
    }

    .recent-file-item {
      background-color: #323639;
      padding: 12px 16px;
      margin-bottom: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .recent-file-item:hover {
      background-color: #5f6368;
    }

    .file-name {
      font-size: 13px;
      color: #e8eaed;
    }

    .file-date {
      font-size: 12px;
      color: #9aa0a6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Study PDF Viewer</h1>
    <p>공부에 최적화된 심플한 PDF 뷰어</p>

    <div class="button-group">
      <button id="openButton">PDF 파일 열기</button>
      <button class="secondary-button" id="mergeButton">PDF 병합</button>
      <button class="secondary-button" id="splitButton">PDF 분할</button>
    </div>

    <div class="drop-zone" id="dropZone">
      <p>또는 여기에 PDF 파일을 드롭하세요</p>
    </div>

    <div class="recent-files" id="recentFiles" style="display: none;">
      <h2>최근 열었던 파일</h2>
      <div id="recentFilesList"></div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const path = require('path');
    const fs = require('fs');

    const openButton = document.getElementById('openButton');
    const mergeButton = document.getElementById('mergeButton');
    const splitButton = document.getElementById('splitButton');
    const dropZone = document.getElementById('dropZone');
    const recentFiles = document.getElementById('recentFiles');
    const recentFilesList = document.getElementById('recentFilesList');

    // Open PDF file
    openButton.addEventListener('click', async () => {
      const filePath = await ipcRenderer.invoke('select-pdf-file');
      if (filePath) {
        // Open in new window instead of current window
        await ipcRenderer.invoke('open-pdf-in-new-window', filePath);
      }
    });

    // Merge PDFs
    mergeButton.addEventListener('click', async () => {
      const { PDFDocument } = require('pdf-lib');

      try {
        const files = await ipcRenderer.invoke('select-multiple-pdf-files');
        if (!files || files.length < 2) {
          alert('최소 2개 이상의 PDF 파일을 선택해주세요.');
          return;
        }

        // Create new PDF document
        const mergedPdf = await PDFDocument.create();

        // Copy pages from each PDF
        for (const filePath of files) {
          const pdfBytes = require('fs').readFileSync(filePath);
          const pdf = await PDFDocument.load(pdfBytes);
          const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
          pages.forEach(page => mergedPdf.addPage(page));
        }

        // Save merged PDF
        const mergedPdfBytes = await mergedPdf.save();

        // Ask user where to save
        const savePath = await ipcRenderer.invoke('save-pdf-file', 'merged.pdf');

        if (savePath) {
          require('fs').writeFileSync(savePath, mergedPdfBytes);
          alert(`PDF 병합이 완료되었습니다!\n저장 위치: ${savePath}`);
        }
      } catch (error) {
        console.error('Error merging PDFs:', error);
        alert('PDF 병합 중 오류가 발생했습니다: ' + error.message);
      }
    });

    // Split PDF
    splitButton.addEventListener('click', async () => {
      const filePath = await ipcRenderer.invoke('select-pdf-file');
      if (filePath) {
        // Open in viewer with split modal
        window.location.href = `viewer.html?file=${encodeURIComponent(filePath)}&action=split`;
      }
    });

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-over');

      const files = Array.from(e.dataTransfer.files);
      const pdfFile = files.find(file => file.path.toLowerCase().endsWith('.pdf'));

      if (pdfFile) {
        await openPDFViewer(pdfFile.path);
      }
    });

    // Prevent default drag behavior on body
    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
    });

    document.body.addEventListener('drop', (e) => {
      e.preventDefault();
    });

    // Open PDF in viewer (in new window)
    async function openPDFViewer(filePath) {
      saveToRecentFiles(filePath);
      await ipcRenderer.invoke('open-pdf-in-new-window', filePath);
    }

    // Save to recent files
    function saveToRecentFiles(filePath) {
      try {
        const settingsPath = path.join(ipcRenderer.sendSync('get-user-data-path'), 'settings.json');
        let settings = { recentFiles: [] };

        if (fs.existsSync(settingsPath)) {
          settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));
        }

        if (!settings.recentFiles) {
          settings.recentFiles = [];
        }

        // Remove if already exists
        settings.recentFiles = settings.recentFiles.filter(item => item.path !== filePath);

        // Add to beginning
        settings.recentFiles.unshift({
          path: filePath,
          lastOpened: Date.now()
        });

        // Keep only last 10
        settings.recentFiles = settings.recentFiles.slice(0, 10);

        fs.writeFileSync(settingsPath, JSON.stringify(settings, null, 2));
      } catch (error) {
        console.error('Error saving recent files:', error);
      }
    }

    // Load recent files
    function loadRecentFiles() {
      try {
        const userDataPath = ipcRenderer.sendSync('get-user-data-path');
        const settingsPath = path.join(userDataPath, 'settings.json');

        if (fs.existsSync(settingsPath)) {
          const settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));

          if (settings.recentFiles && settings.recentFiles.length > 0) {
            recentFiles.style.display = 'block';
            recentFilesList.innerHTML = '';

            settings.recentFiles.forEach(item => {
              if (fs.existsSync(item.path)) {
                const fileItem = document.createElement('div');
                fileItem.className = 'recent-file-item';

                const fileName = path.basename(item.path);
                const date = new Date(item.lastOpened).toLocaleDateString('ko-KR');

                fileItem.innerHTML = `
                  <span class="file-name">${fileName}</span>
                  <span class="file-date">${date}</span>
                `;

                fileItem.addEventListener('click', () => {
                  openPDFViewer(item.path);
                });

                recentFilesList.appendChild(fileItem);
              }
            });
          }
        }
      } catch (error) {
        console.error('Error loading recent files:', error);
      }
    }

    // Handle IPC events from main process
    ipcRenderer.on('open-pdf', (event, filePath) => {
      openPDFViewer(filePath);
    });

    // Make get-user-data-path synchronous
    ipcRenderer.on('get-user-data-path', (event) => {
      event.returnValue = require('electron').remote.app.getPath('userData');
    });

    // Load recent files on startup
    loadRecentFiles();
  </script>
</body>
</html>
